<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Para √áek</title>
<style>
  /* Genel Reset */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f7fa;
    color: #333;
    margin: 0;
    padding: 20px;
    max-width: 480px;
    margin-left: auto;
    margin-right: auto;
  }
  h2 {
    text-align: center;
    font-weight: 700;
    color: #222;
    margin-bottom: 30px;
  }
  form {
    background: #fff;
    border-radius: 10px;
    padding: 25px 30px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
  }
  label {
    display: block;
    margin-top: 20px;
    font-weight: 600;
    color: #555;
  }
  select, input[type="text"], input[type="number"], input[type="file"] {
    width: 100%;
    padding: 12px 14px;
    margin-top: 8px;
    border-radius: 6px;
    border: 1.5px solid #ccc;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }
  select:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="file"]:focus {
    border-color: #7aa7ff;
    outline: none;
    box-shadow: 0 0 6px rgba(122,167,255,0.5);
  }
  button {
    width: 100%;
    padding: 14px;
    margin-top: 30px;
    background-color: #4a90e2;
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }
  button:disabled {
    background-color: #a5b8e0;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background-color: #3573cc;
  }
  #paymentNotice {
    background: #e3f2fd;
    border: 1px solid #90caf9;
    color: #0d47a1;
    padding: 18px 22px;
    margin-top: 25px;
    border-radius: 8px;
    font-weight: 600;
  }
  #paymentNotice p {
    margin: 0 0 12px 0;
    font-size: 1.05rem;
  }
  #paymentDetails p {
    margin: 6px 0;
  }
  #message {
    margin-top: 22px;
    min-height: 24px;
    font-weight: 600;
    text-align: center;
  }
  #balanceDisplay {
    text-align: center;
    margin-bottom: 15px;
    font-weight: 700;
    font-size: 1.2rem;
    color: #1e2a78;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 30px;
    font-size: 0.9rem;
  }
  table, th, td {
    border: 1px solid #ddd;
  }
  th, td {
    padding: 10px;
    text-align: center;
  }
  th {
    background: #4a90e2;
    color: white;
  }

  @media (max-width: 480px) {
    body {
      padding: 15px;
      max-width: 100%;
    }
    form {
      padding: 20px;
    }
  }
</style>
</head>
<body>

<h2>üèõÔ∏è Para √áek üèõÔ∏è</h2>

<div id="balanceDisplay">Bakiye: Y√ºkleniyor...</div>

<form id="withdrawForm" onsubmit="return false;">
  <label for="method">√áekim Y√∂ntemi Se√ßiniz:</label>
  <select id="method" required>
    <option value="" selected disabled>Se√ßiniz</option>
    <option value="usdt">USDT TRC20</option>
    <option value="ton">TON</option>
    <option value="eft">Havale / EFT</option>
  </select>

  <div id="dynamicFields"></div>

  <button id="withdrawBtn" type="button" disabled>Para √áek</button>
</form>

<div id="paymentNotice" style="display:none;">
  <p><strong>TEK SEFERLƒ∞K √áekim √úcretini Yatƒ±rƒ±n L√ºtfen Ger√ßek kullanƒ±cƒ± olduƒüunuzu Doƒürulayƒ±n Gerekli. (6 USDT)</strong></p>

  <label for="paymentOption">√ñdeme Se√ßeneƒüi:</label>
  <select id="paymentOption">
    <option value="tonAddress">1. TON Adresi</option>
    <option value="ibanInfo">2. IBAN Bilgileri</option>
  </select>

  <div id="paymentDetails" style="margin-top:12px;"></div>

  <label for="receiptUpload">Dekont Y√ºkle:</label>
  <input type="file" id="receiptUpload" accept="image/*,application/pdf" required />

  <button id="paidBtn" disabled>Yatƒ±rdƒ±m</button>
</div>

<div id="message"></div>

<h2>√áekim Taleplerim</h2>
<table id="userWithdrawalsTable">
  <thead>
    <tr>
      <th>Miktar (USDT)</th>
      <th>Durum</th>
      <th>Red Sebebi</th>
      <th>Talep Tarihi</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBXddctTbfBzgJ9sgtVCvSMtNJRd3JVeHs",
    authDomain: "crypto-eccb4.firebaseapp.com",
    projectId: "crypto-eccb4",
    storageBucket: "crypto-eccb4.appspot.com",
    messagingSenderId: "773649197313",
    appId: "1:773649197313:web:18da6ed3ee63353c4e9300"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const minWithdrawAmount = 30;
  const withdrawFee = 0; // Para √ßekim √ºcreti (6 USDT olarak g√ºncelledim)

  const myTonAddress = "UQDalUFWerAg7Bo8-NHtX8OgFHRHI8-OvqpqjXjRDZREXzaF";
  const myIbanInfo = {
    iban: "TR230001002271762072685090",
    alici: "Paladyum Elektronik Para ve √ñdeme Hizmetleri A.≈û.",
    aciklama: "904126059"
  };

  const balanceDisplay = document.getElementById("balanceDisplay");
  const methodSelect = document.getElementById("method");
  const dynamicFields = document.getElementById("dynamicFields");
  const withdrawBtn = document.getElementById("withdrawBtn");
  const paymentNotice = document.getElementById("paymentNotice");
  const paymentOption = document.getElementById("paymentOption");
  const paymentDetails = document.getElementById("paymentDetails");
  const receiptUpload = document.getElementById("receiptUpload");
  const paidBtn = document.getElementById("paidBtn");
  const messageDiv = document.getElementById("message");
  const withdrawalsTableBody = document.querySelector("#userWithdrawalsTable tbody");

  let currentMethod = null;
  let userTonAddress = "";
  let userBalance = 0;
  let currentWithdrawAmount = 0;
  let currentAddressOrInfo = {};
  let currentUserEmail = null;

  // Kullanƒ±cƒ± auth ve bakiye y√ºkleme
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }
    currentUserEmail = user.email;
    try {
      const userDoc = await db.collection("users").doc(user.uid).get();
      if (userDoc.exists) {
        userBalance = parseFloat(userDoc.data().balance || 0);
        balanceDisplay.textContent = `Bakiye: ${userBalance.toFixed(4)} USDT`;
        withdrawBtn.disabled = false;
      } else {
        userBalance = 0;
        balanceDisplay.textContent = "Bakiye: 0.0000 USDT";
        withdrawBtn.disabled = true;
      }
      loadUserWithdrawals(currentUserEmail);
    } catch (e) {
      balanceDisplay.textContent = "Bakiye bilgisi alƒ±namadƒ±.";
      withdrawBtn.disabled = true;
      console.error(e);
    }
  });

  // Dinamik alanlar ve √ßekim y√∂ntemi
  methodSelect.addEventListener("change", () => {
    currentMethod = methodSelect.value;
    userTonAddress = "";
    dynamicFields.innerHTML = "";
    paymentNotice.style.display = "none";
    messageDiv.textContent = "";
    paidBtn.disabled = true;
    receiptUpload.value = "";
    paymentOption.value = "tonAddress";
    updatePaymentDetails();

    if (currentMethod === "usdt") {
      dynamicFields.innerHTML = `
        <label for="addressInput">USDT TRC20 Adresi:</label>
        <input type="text" id="addressInput" placeholder="TRC20 c√ºzdan adresinizi girin" autocomplete="off" required />
        <label for="amountInput">√áekilecek Miktar (min ${minWithdrawAmount} USDT):</label>
        <input type="number" id="amountInput" placeholder="Miktar" min="${minWithdrawAmount}" step="0.01" required />
      `;
    } else if (currentMethod === "ton") {
      dynamicFields.innerHTML = `
        <label for="tonAddressInput">TON Adresi:</label>
        <input type="text" id="tonAddressInput" placeholder="TON c√ºzdan adresinizi girin" autocomplete="off" required />
        <small>Sabit TON adresi: <strong>${myTonAddress}</strong></small>
        <label for="amountInput">√áekilecek Miktar (min ${minWithdrawAmount} USDT):</label>
        <input type="number" id="amountInput" placeholder="Miktar" min="${minWithdrawAmount}" step="0.01" required />
      `;
      document.getElementById("tonAddressInput").addEventListener("input", e => {
        userTonAddress = e.target.value.trim();
      });
    } else if (currentMethod === "eft") {
      dynamicFields.innerHTML = `
        <label for="nameInput">Ad Soyad:</label>
        <input type="text" id="nameInput" placeholder="Ad Soyad" required />
        <label for="ibanInput">IBAN:</label>
        <input type="text" id="ibanInput" placeholder="IBAN" required />
        <label for="bankInput">Banka Adƒ±:</label>
        <input type="text" id="bankInput" placeholder="Banka Adƒ±" required />
        <label for="amountInput">√áekilecek Miktar (min ${minWithdrawAmount} USDT):</label>
        <input type="number" id="amountInput" placeholder="Miktar" min="${minWithdrawAmount}" step="0.01" required />
      `;
    }
  });

  // √ñdeme detaylarƒ± g√ºncelleme
  function updatePaymentDetails() {
    if (paymentOption.value === "tonAddress") {
      paymentDetails.innerHTML = `<p><strong>TON Adresi:</strong> ${myTonAddress}</p>`;
    } else if (paymentOption.value === "ibanInfo") {
      paymentDetails.innerHTML = `
        <p><strong>IBAN:</strong> ${myIbanInfo.iban}</p>
        <p><strong>Alƒ±cƒ±:</strong> ${myIbanInfo.alici}</p>
        <p><strong>A√ßƒ±klama:</strong> ${myIbanInfo.aciklama}</p>
      `;
    }
  }
  paymentOption.addEventListener("change", updatePaymentDetails);

  // Para √áek butonu tƒ±klama
  withdrawBtn.addEventListener("click", () => {
    messageDiv.style.color = "red";
    messageDiv.textContent = "";

    if (!currentMethod) {
      messageDiv.textContent = "L√ºtfen √ßekim y√∂ntemini se√ßin.";
      return;
    }

    let amount = 0;
    let addressOrInfo = {};

    if (currentMethod === "usdt") {
      const addressInput = document.getElementById("addressInput");
      const amountInput = document.getElementById("amountInput");
      if (!addressInput.value || addressInput.value.trim().length < 10) {
        messageDiv.textContent = "Ge√ßerli bir TRC20 adresi girin.";
        return;
      }
      if (!amountInput.value || parseFloat(amountInput.value) < minWithdrawAmount) {
        messageDiv.textContent = `Minimum ${minWithdrawAmount} USDT √ßekebilirsiniz.`;
        return;
      }
      amount = parseFloat(amountInput.value);
      addressOrInfo = { address: addressInput.value.trim() };
    } else if (currentMethod === "ton") {
      const amountInput = document.getElementById("amountInput");
      if (!userTonAddress || userTonAddress.length < 10) {
        messageDiv.textContent = "Ge√ßerli bir TON adresi girin.";
        return;
      }
      if (!amountInput.value || parseFloat(amountInput.value) < minWithdrawAmount) {
        messageDiv.textContent = `Minimum ${minWithdrawAmount} USDT √ßekebilirsiniz.`;
        return;
      }
      amount = parseFloat(amountInput.value);
      addressOrInfo = { tonAddress: userTonAddress };
    } else if (currentMethod === "eft") {
      const nameInput = document.getElementById("nameInput");
      const ibanInput = document.getElementById("ibanInput");
      const bankInput = document.getElementById("bankInput");
      const amountInput = document.getElementById("amountInput");
      if (!nameInput.value.trim() || !ibanInput.value.trim() || !bankInput.value.trim()) {
        messageDiv.textContent = "L√ºtfen t√ºm Havale/EFT bilgilerini doldurun.";
        return;
      }
      if (!amountInput.value || parseFloat(amountInput.value) < minWithdrawAmount) {
        messageDiv.textContent = `Minimum ${minWithdrawAmount} USDT √ßekebilirsiniz.`;
        return;
      }
      amount = parseFloat(amountInput.value);
      addressOrInfo = {
        name: nameInput.value.trim(),
        iban: ibanInput.value.trim(),
        bank: bankInput.value.trim()
      };
    }

    if (amount > userBalance) {
      messageDiv.textContent = `Yetersiz bakiye. Bakiyeniz: ${userBalance.toFixed(4)} USDT. Minimum √ßekim: ${minWithdrawAmount} USDT.`;
      return;
    }

    currentWithdrawAmount = amount;
    currentAddressOrInfo = addressOrInfo;

    paymentNotice.style.display = "block";
    paidBtn.disabled = true;
    receiptUpload.value = "";
    messageDiv.textContent = "";
  });

  // Dekont se√ßilince Yatƒ±rdƒ±m butonunu aktif et
  receiptUpload.addEventListener("change", () => {
    paidBtn.disabled = receiptUpload.files.length === 0;
  });

  // Yatƒ±rdƒ±m butonuna basƒ±nca
  paidBtn.addEventListener("click", async () => {
    if (receiptUpload.files.length === 0) {
      messageDiv.style.color = "red";
      messageDiv.textContent = "L√ºtfen dekont dosyasƒ± se√ßin.";
      return;
    }

    try {
      messageDiv.style.color = "black";
      messageDiv.textContent = "ƒ∞≈ülem yapƒ±lƒ±yor, l√ºtfen bekleyin...";

      const user = auth.currentUser;
      if (!user) {
        messageDiv.style.color = "red";
        messageDiv.textContent = "L√ºtfen giri≈ü yapƒ±n.";
        return;
      }

      await db.runTransaction(async (t) => {
        const userBalanceRef = db.collection("users").doc(user.uid);
        const userDoc = await t.get(userBalanceRef);
        if (!userDoc.exists) throw new Error("Kullanƒ±cƒ± bakiyesi bulunamadƒ±.");
        const currentBalance = parseFloat(userDoc.data().balance || 0);
        const totalDeduct = currentWithdrawAmount + withdrawFee;

        if (currentBalance < totalDeduct) {
          throw new Error("Yetersiz bakiye. L√ºtfen bakiye durumunuzu kontrol edin.");
        }

        const withdrawalRef = db.collection("withdrawals").doc();
        t.set(withdrawalRef, {
          userId: user.uid,
          userEmail: user.email,
          method: currentMethod,
          amount: currentWithdrawAmount,
          addressOrInfo: currentAddressOrInfo,
          paymentOption: paymentOption.value,
          receiptFileName: receiptUpload.files[0].name,
          status: "pending",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        t.update(userBalanceRef, { balance: currentBalance - totalDeduct });
      });

      // G√ºncellenmi≈ü bakiye g√∂sterimi
      userBalance -= (currentWithdrawAmount + withdrawFee);
      balanceDisplay.textContent = `Bakiye: ${userBalance.toFixed(4)} USDT`;

      messageDiv.style.color = "green";
      messageDiv.textContent = "√áekim talebiniz Ba≈üarƒ±yla alƒ±ndƒ± en kƒ±sa s√ºrede sonu√ßlanacaktƒ±r.";

      // Form sƒ±fƒ±rlama
      methodSelect.value = "";
      dynamicFields.innerHTML = "";
      paymentNotice.style.display = "none";
      paidBtn.disabled = true;
      receiptUpload.value = "";
      withdrawBtn.disabled = false;

      loadUserWithdrawals(currentUserEmail);

    } catch (err) {
      messageDiv.style.color = "red";
      messageDiv.textContent = "Hata: " + err.message;
      console.error(err);
    }
  });

  // Kullanƒ±cƒ±nƒ±n √ßekim taleplerini listele
  async function loadUserWithdrawals(email) {
    withdrawalsTableBody.innerHTML = "<tr><td colspan='4'>Y√ºkleniyor...</td></tr>";
    try {
      const querySnapshot = await db.collection("withdrawals")
        .where("userEmail", "==", email)
        .orderBy("createdAt", "desc")
        .limit(10)
        .get();

      if (querySnapshot.empty) {
        withdrawalsTableBody.innerHTML = "<tr><td colspan='4'>Hen√ºz √ßekim talebiniz yok.</td></tr>";
        return;
      }

      withdrawalsTableBody.innerHTML = "";
      querySnapshot.forEach(doc => {
        const w = doc.data();
        const createdAt = w.createdAt ? w.createdAt.toDate().toLocaleString() : "-";
        const status = w.status === "pending" ? "Beklemede" :
                       w.status === "approved" ? "Onaylandƒ±" :
                       w.status === "rejected" ? "Reddedildi" : w.status;

        withdrawalsTableBody.innerHTML += `
          <tr>
            <td>${w.amount.toFixed(4)}</td>
            <td>${status}</td>
            <td>${w.rejectionReason ? w.rejectionReason : "-"}</td>
            <td>${createdAt}</td>
          </tr>
        `;
      });
    } catch (err) {
      withdrawalsTableBody.innerHTML = "<tr><td colspan='4'>Veriler alƒ±namadƒ±.</td></tr>";
      console.error(err);
    }
  }

</script>
<!-- Men√º -->
<div id="bottomMenu"></div>
<script>
  fetch("bottom-menu.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("bottomMenu").innerHTML = html;
    });
</script>
<script src="men√º.js"></script>

</body>
</html>
